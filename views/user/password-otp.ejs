<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OTP Verification</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .resend-disabled {
      pointer-events: none;
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <div class="container d-flex justify-content-center align-items-center vh-100">
    <div class="card p-4 shadow-lg" style="width: 22rem;">
      <h4 class="card-title text-center">OTP Verification</h4>
      <p class="text-muted text-center">Enter the 6-digit OTP sent to your email/phone</p>
      
      <form id="otp-form">
        <div class="mb-3">
          <input 
            type="text" 
            id="otp"
            class="form-control text-center" 
            maxlength="6" 
            pattern="\d{6}" 
            placeholder="Enter OTP" 
          >
        </div>
        <button type="submit" class="btn btn-primary w-100">Verify</button>
      </form>

      <div class="text-center mt-3">
        <span id="timer">Resend OTP in <strong>30</strong> seconds</span>
        <button id="resend-btn" class="btn btn-link resend-disabled" type="button" onclick="resendOTP()">Resend OTP</button>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // Countdown Timer for Resend OTP
    let timer = 30;
    let timerInterval;
    const timerElement = document.getElementById('timer');
    const resendBtn = document.getElementById('resend-btn');
    function startTimer() {
      timerInterval = setInterval(() => {
        timer--;
        timerElement.innerHTML = `Resend OTP in <strong>${timer}</strong> seconds`;
        if (timer <= 0) {
        clearInterval(timerInterval);
        timerElement.innerHTML = "";
        resendBtn.classList.remove('resend-disabled');
        resendBtn.disabled = false;
      }
      },1000)
    }

    startTimer();


    function validateOTPForm(e) {
      e.preventDefault();
      const otpInput = document.getElementById('otp').value;
      fetch('/passwordOtp', {
        method: 'POST',
        headers: {
          'content-type': 'application/json'
        },
        body: JSON.stringify({otpInput})
      })
      .then((response) => {
        if(!response.ok) {
          throw new Error(`HTTP error! status code: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        if(data.success) {
          Swal.fire({
              position: "top-end",
              icon: 'success',
              title: 'OTP Verified Successfully',
              showConfirmButton: false,
              timer: 1500,
              customClass: {
                popup: 'custom-swal-popup'
            }
            }).then(() => {
              window.location.href = response.redirectUrl;
            });
        } else {
          Swal.fire({
            position: "top-end",
            icon: "error",
            title: "Oops...",
            text: data.message,
            showConfirmButton: false,
            timer: 1500,
            customClass: {
                popup: 'custom-swal-popup'
            }
          });
        }
      })
      .catch((error) => {
        console.log(error)
        Swal.fire({
            position: "top-end",
            icon: "error",
            title: "Oops...",
            text: error.message,
            showConfirmButton: false,
            timer: 1500,
            customClass: {
                popup: 'custom-swal-popup'
            }
          });
      })
    }

    function resendOTP() {
      clearInterval(timerInterval);
      timer = 30;
      resendBtn.classList.add('resend-disabled');
      resendBtn.disabled = true;
      timerElement.innerHTML = "";
      startTimer();
      $.ajax({
        type: 'POST',
        url: '/resend-otp',
        success: function(response) {
          if(response.success) {
            Swal.fire({
              icon: 'success',
              title: 'OTP Resend Successfully',
              showConfirmButton: false,
              timer: 1500
            })
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'An error occured while resending OTP. Please try again'
            })
          }
        }
      })
      return false;
    }

    document.getElementById('otp-form').addEventListener('submit', validateOTPForm)
  </script>
</body>
</html>
